# 选型算法测试指南

**版本**：v2.0
**更新日期**：2026-02-08

---

## 📋 测试目标

验证优化后的选型算法是否能够：
1. ✅ 只选择大于等于需求值的产品
2. ✅ 优先推荐余量适中的产品
3. ✅ 综合评分排序合理

---

## 🧪 测试方法

### 前置条件

需要先配置数据库并添加测试数据：

```powershell
# 1. 启动PostgreSQL
# 2. 创建数据库
psql -U postgres -c "CREATE DATABASE lovato_pump;"

# 3. 运行数据库迁移
pnpm run db:push

# 4. 添加测试数据
# 可以使用 seed 脚本或手动添加
pnpm run db:seed
```

---

## 🎯 测试用例

### 测试用例1：基本选型

**测试目标**：验证算法返回的产品都满足"大于等于需求值"

**输入参数**：
```json
{
  "flowRate": 50,
  "head": 30
}
```

**预期结果**：
- ✅ 所有返回的产品，流量 >= 50 m³/h
- ✅ 所有返回的产品，扬程 >= 30 m
- ✅ 结果按综合评分从高到低排序

**验证方法**：
```powershell
# 使用 curl 测试
curl -X POST http://localhost:5000/api/pumps/select \
  -H "Content-Type: application/json" \
  -d '{"flowRate": 50, "head": 30}' | jq '.'
```

---

### 测试用例2：余量适中优先

**测试目标**：验证余量适中的产品排在前面

**输入参数**：
```json
{
  "flowRate": 100,
  "head": 50
}
```

**预期结果**：
- ⭐ 第1名：流量105-120 m³/h（余量5%-20%），扬程53-58 m（余量6%-16%）
- ✅ 第2名：流量102-110 m³/h（余量2%-10%），扬程51-55 m（余量2%-10%）
- ⚠️ 第3名：流量150+ m³/h（余量>50%），扬程70+ m（余量>40%）

**验证方法**：
检查返回结果的前几个产品，验证：
1. 第1个产品的流量和扬程余量在最佳范围
2. 后续产品的综合评分递减

---

### 测试用例3：无匹配结果

**测试目标**：验证无匹配结果时的处理

**输入参数**：
```json
{
  "flowRate": 1000,
  "head": 500
}
```

**预期结果**：
- ✅ 返回空数组 `[]`
- ✅ 推荐热门产品列表

**验证方法**：
```powershell
curl -X POST http://localhost:5000/api/pumps/select \
  -H "Content-Type: application/json" \
  -d '{"flowRate": 1000, "head": 500}'
```

---

### 测试用例4：综合评分验证

**测试目标**：验证综合评分计算的准确性

**输入参数**：
```json
{
  "flowRate": 50,
  "head": 30
}
```

**手动计算示例**：

假设有产品A：
- 流量：55 m³/h（余量10%）
- 扬程：32 m（余量7%）
- 效率：75%
- BEP匹配度：0.9（最佳）

**评分计算**：
1. 满足度评分：
   - 流量满足度：50分（余量10%，在最佳范围）
   - 扬程满足度：50分（余量7%，在最佳范围）
   - 满足度综合：50分

2. 流量余量评分：82.5分（余量10%，在最佳范围）

3. 扬程余量评分：82.5分（余量7%，在最佳范围）

4. 效率评分：95分（效率75%，最佳效率）

5. BEP匹配度：95分（最佳匹配）

**综合评分**：
```
= 50 × 30% + 95 × 25% + 95 × 20% + 82.5 × 15% + 82.5 × 10%
= 15 + 23.75 + 19 + 12.375 + 8.25
= 78.375分
```

**验证方法**：
检查API返回的 `comprehensiveScore` 是否与手动计算结果接近。

---

## 🔍 前端测试

### 测试步骤

1. **访问选型页面**
   ```
   http://localhost:5000/selection
   ```

2. **输入参数**
   - 流量需求：50 m³/h
   - 扬程需求：30 m
   - 应用类型：供水系统
   - 流体类型：清水

3. **点击"开始选型"**

4. **验证结果**
   - ✅ 显示匹配的产品列表
   - ✅ 检查第一个产品的流量和扬程是否大于等于需求
   - ✅ 查看性能曲线图，确认需求点在曲线下方

5. **验证排序**
   - ✅ 第一个产品的综合评分最高
   - ✅ 后续产品的评分递减

6. **验证性能曲线**
   - ✅ 性能曲线正常显示
   - ✅ 红色参考线标注需求点
   - ✅ 需求点在曲线下方（满足"选大不选小"）

---

## 📊 测试数据

### 推荐测试数据

| 测试场景 | 流量 (m³/h) | 扬程 (m) | 预期结果 |
|---------|-----------|---------|---------|
| 小型需求 | 20 | 15 | 返回小型泵，余量5%-20% |
| 中型需求 | 100 | 50 | 返回中型泵，余量5%-20% |
| 大型需求 | 500 | 200 | 返回大型泵，余量5%-20% |
| 极端需求 | 1000 | 500 | 返回空数组，推荐热门产品 |

---

## 🐛 常见问题

### 问题1：返回的产品不满足需求

**原因**：数据库中的性能曲线数据不准确

**解决方法**：
```powershell
# 重新生成性能曲线
curl -X POST http://localhost:5000/api/pumps/init-performance
```

### 问题2：排序不正确

**原因**：综合评分计算有误

**解决方法**：
1. 检查日志中的评分计算过程
2. 验证各个维度的评分是否正确
3. 检查权重分配是否正确

### 问题3：无匹配结果

**原因**：数据库中没有满足需求的产品

**解决方法**：
1. 添加更多产品数据
2. 检查性能曲线数据是否完整
3. 验证需求参数是否合理

---

## 📝 测试报告模板

```markdown
# 选型算法测试报告

**测试日期**：2026-02-08
**测试人员**：[姓名]
**测试环境**：本地开发环境

## 测试用例

### 用例1：基本选型
- **输入**：流量50，扬程30
- **预期**：返回满足需求的产品
- **实际**：[描述实际结果]
- **结果**：✅ 通过 / ❌ 失败

### 用例2：余量适中优先
- **输入**：流量100，扬程50
- **预期**：余量适中的产品排在前面
- **实际**：[描述实际结果]
- **结果**：✅ 通过 / ❌ 失败

### 用例3：无匹配结果
- **输入**：流量1000，扬程500
- **预期**：返回空数组，推荐热门产品
- **实际**：[描述实际结果]
- **结果**：✅ 通过 / ❌ 失败

## 总结

- **测试通过**：X / Y
- **发现的问题**：[列出问题]
- **建议**：[给出建议]
```

---

## 🎓 测试要点

### 关键验证点

1. **SQL查询条件**
   ```typescript
   sql`${pumpPerformancePoints.flowRate} >= ${options.flowRate}`
   sql`${pumpPerformancePoints.head} >= ${options.head}`
   ```
   ✅ 验证：只返回满足"大于等于"条件的产品

2. **综合评分排序**
   ```typescript
   .sort((a, b) => b.comprehensiveScore - a.comprehensiveScore)
   ```
   ✅ 验证：结果按综合评分从高到低排序

3. **满足度评分**
   ✅ 验证：余量在最佳范围（5%-20%）的产品得到更高分

4. **前端显示**
   ✅ 验证：性能曲线图正确显示，需求点在曲线下方

---

## 📚 相关文档

- [选型算法优化说明](SELECTION-ALGORITHM-OPTIMIZATION.md)
- [API接口文档](docs/API.md)
- [泵管理器代码](src/storage/database/pumpManager.ts)

---

**测试指南版本**：v1.0
**最后更新**：2026-02-08
**状态**：✅ 已完成
