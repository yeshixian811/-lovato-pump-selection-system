# 洛瓦托水泵选型系统 - 项目压缩摘要

## 用户需求与目标
- 原始目标: 创建并部署洛瓦托水泵选型系统，包括Web应用、微信小程序及服务器环境配置。
- 当前目标: 全面自检并修复系统安全漏洞，准备本地部署文件。
- 验收标准与约束:
  - 必须使用 HTTPS 用于微信小程序 WebView。
  - 数据库数据目录需迁移至 J 盘（若适用）。
  - 部署环境为本地 Windows 电脑，而非 Coze 沙箱。
  - 应用服务端口已从 3002 修改回 5000 以支持 Coze 沙箱预览和外网访问。
  - 页面需支持 H5 移动端自适应，且符合微信小程序要求。
  - 登录页 LOGO 需显示在最左侧。
  - 选型页面参数输入和结果需在平板及以上并排显示。
  - 选型算法参考格兰富官网选型逻辑。
- 偏好:
  - 使用 Cloudflare Tunnel 作为长期内网穿透方案。
  - 数据库数据存储在 J 盘 (`J:/postgresql/data`)。
  - 选型算法基于水泵性能曲线（H-Q曲线）进行匹配。
  - 参数输入页面采用紧凑布局，取消滚动条和滑动条。
  - 选型结果页面参数区域占1/3宽度，结果区域占2/3宽度。
  - 性能曲线图高度增加50%，刻度精度统一为0.1。
  - 无匹配结果时自动显示推荐产品列表。
  - 性能曲线图表边距调整为最小值，紧靠左下角显示。
  - 性能曲线参考线使用细实线。
  - 性能曲线支持鼠标滚轮缩放，且缩放时锁定页面滚动。
  - 性能曲线坐标轴基于产品最大扬程和最大流量规划。
  - 选型算法遵循"选大不选小"原则，基于三线交叉点（流量参考线、扬程参考线、性能曲线）。
  - 删除匹配度显示，界面更简洁。
  - 只显示大于需求点的型号（三线交叉点匹配）。
  - **产品库滚动条必须始终显示在页面最前方**。
  - **所有最大流量和最大扬程参数必须严格对应实际输入值，不使用倍数估算**。
  - **产品库表单必填字段必须优先显示，无需滚动即可看到**。

## 项目概览
- 概述: 洛瓦托水泵选型系统，包含 Next.js Web 应用、微信小程序、版本管理系统、进销存管理及 PostgreSQL 数据库。
- 技术栈:
  - Next.js 16 (App Router)
  - React 19
  - PostgreSQL 14
  - Node.js 24
  - pnpm
  - Cloudflare Tunnel (内网穿透)
  - Recharts (图表库)
  - coze-coding-dev-sdk (对象存储)
- 编码规范: 未明确指定。

## 关键决策
- 选择 Cloudflare Tunnel 作为长期内网穿透方案（相比 ngrok，域名固定且免费）。
- 将 PostgreSQL 数据库数据目录配置为 J 盘 (`J:/postgresql/data`)，以解决磁盘空间或管理需求。
- 将应用服务端口从 3002 修改回 5000，以适配 Coze 沙箱预览系统（外网访问限制）及用户本地环境配置。
- 实现全站 H5 移动端自适应，并添加微信小程序 WebView 兼容性支持。
- 选型页面布局调整为：小屏幕上下排列，平板及以上左右并排。
- 实现版本管理系统，支持代码备份、回滚和在线编辑。
- 删除 GITHUB 部署配置，改用本地部署。
- 新增进销存管理模块，支持库存、采购、销售及供应商/客户管理。
- 选型算法改为基于性能曲线（H-Q曲线）匹配，流量和扬程需求作为坐标参考。
- 选型结果页面布局优化为左侧参数输入（1/3宽度），右侧结果展示（2/3宽度）。
- 使用 Recharts 绘制 H-Q 性能曲线图，高度设为 h-72，刻度精度 0.1。
- 性能曲线图表边距设为最小值（top: 0, right: 0, left: 10, bottom: 10），紧靠左下角显示。
- 性能曲线参考线改为细实线（strokeWidth: 1）。
- 性能曲线支持鼠标滚轮缩放，不显示底部刻度条。
- 性能曲线坐标轴范围基于产品的 `max_flow_rate` 和 `max_head` 规划。
- 选型算法遵循"选大不选小"原则：在需求流量处，性能曲线扬程必须 >= 需求扬程。
- 选型算法优化为参考格兰富官网选型逻辑，引入最佳效率区间（BEP）评分。
- 删除选型结果页面的匹配度显示。
- 实现性能曲线锁定页面滚动功能，鼠标进入图表区域时禁止页面滚动。
- **性能曲线生成逻辑改为基于实际输入的最大流量和最大扬程，使用二次曲线模型，确保在最大流量点扬程为0**。
- **产品库管理页面滚动条优化为始终显示在最前方，使用高 z-index 和自定义样式**。
- **产品库表单必填字段优先显示，添加示例提示，移除废弃字段**。
- **修复 SQL 注入漏洞：使用 Drizzle ORM 参数化查询替代字符串拼接**。
- **修复文件上传配置：添加环境变量读取和安全警告注释**。

## 核心文件修改
- 文件操作:
  - edit: `src/app/api/pumps/init-performance/route.ts` (修复 SQL 注入漏洞，使用 `pumpManager.deletePerformancePoints` 和 `db.insert` 参数化查询)
  - edit: `src/app/api/storage/upload/route.ts` (添加环境变量读取 `COZE_BUCKET_ACCESS_KEY` 和 `COZE_BUCKET_SECRET_KEY`，添加安全警告注释)
  - create: `DEPLOYMENT.md` (本地部署指南，包含系统要求、部署步骤、常见问题、性能优化、安全建议)
  - create: `quick-start.bat` (Windows 快速启动脚本，检查 Node.js/pnpm/端口/依赖，启动开发服务)
  - create: `deploy-local.bat` (Windows 完整部署向导，引导用户完成所有配置步骤)
  - create: `health-check.bat` (系统健康检查脚本，检查环境和配置状态)
  - create: `migrate-to-j-drive.bat` (数据库迁移脚本，将 PostgreSQL 数据迁移到 J 盘)
  - create: `DEPLOYMENT-SCRIPTS-README.md` (部署脚本说明文档)
  - create: `SECURITY-CHECKLIST.md` (安全检查清单，详细记录安全审计结果)
  - create: `src/storage/database/pumpManager.ts` (新增 `deletePerformancePoints` 方法，使用 Drizzle ORM 参数化查询)
  - edit: `README.md` (添加部署脚本和安全检查说明)
- 关键修改:
  - **修复 SQL 注入漏洞**：
    - 移除 `db.execute` 中的字符串拼接 SQL 语句。
    - 使用 `pumpManager.deletePerformancePoints(pumpId)` 方法（内部使用 `db.delete(pumpPerformancePoints).where(eq(pumpPerformancePoints.pumpId, pumpId))`）。
    - 使用 `db.insert(pumpPerformancePoints).values()` 方法进行批量插入。
  - **修复文件上传配置**：
    - 将 `accessKey` 和 `secretKey` 从硬编码空字符串改为从环境变量读取。
    - 添加安全警告注释，提示用户配置正确的凭证。
  - **创建本地部署指南**：
    - 编写详细的 Windows 本地部署步骤。
    - 包含软件安装、数据库配置、环境变量设置、依赖安装、服务启动、内网穿透配置等。
    - 提供常见问题解决方案（端口占用、数据库连接失败、pnpm 安装失败、文件上传功能不工作）。
    - 包含性能优化建议（数据库优化、应用优化）和安全建议（修改默认密码、配置防火墙、使用 HTTPS、定期备份）。
  - **创建快速启动脚本**：
    - 自动检查 Node.js 和 pnpm 是否安装。
    - 自动安装项目依赖。
    - 检查端口 5000 是否被占用。
    - 一键启动开发服务。
  - **创建部署向导脚本**：
    - 完整的本地部署流程引导。
    - 检查系统环境（Node.js、pnpm、PostgreSQL）。
    - 检查数据库连接。
    - 安装项目依赖。
    - 配置环境变量。
    - 初始化数据库。
    - 启动服务（开发或生产模式）。
  - **创建系统健康检查脚本**：
    - 检查 Node.js 和 pnpm 安装。
    - 检查 PostgreSQL 安装和服务状态。
    - 检查项目依赖和环境变量。
    - 检查端口占用情况。
    - 检查数据库连接。
    - 检查构建状态。
  - **创建数据库迁移脚本**：
    - 备份当前数据库。
    - 停止 PostgreSQL 服务。
    - 将数据文件迁移到 J 盘（`J:\postgresql\data`）。
    - 重新配置 PostgreSQL。
    - 启动服务并验证。
  - **优化泵管理器**：
    - 新增 `deletePerformancePoints` 方法，用于安全删除性能曲线数据。
    - 使用 Drizzle ORM 的参数化查询，防止 SQL 注入。

## 问题或错误及解决方案
- 问题: SQL 注入漏洞（严重）。
  - 解决方案: 使用 Drizzle ORM 的参数化查询替代字符串拼接，移除所有直接拼接 SQL 的代码。
- 问题: 文件上传凭证未配置（中）。
  - 解决方案: 添加环境变量读取逻辑，并添加安全警告注释，提示用户在 `.env` 文件中配置正确的凭证。
- 问题: 缺少 API 认证和授权机制（高）。
  - 解决方案: 已在安全报告中标记，建议实现基于 JWT 的认证机制，为管理后台 API 添加权限验证。
- 问题: 缺少 API 速率限制（中）。
  - 解决方案: 已在安全报告中标记，建议使用 `@upstash/ratelimit` 库实现速率限制。
- 问题: 缺少 CORS 配置（低）。
  - 解决方案: 已在安全报告中标记，建议配置明确的 CORS 白名单。

## TODO
- ✅ 全面自检并修复系统安全漏洞
- ✅ 创建本地部署文件
- ✅ 添加环境变量读取和安全警告
- ✅ 创建部署脚本和文档
- ✅ 编写安全检查清单

## 下一步建议
1. **实施 JWT 认证机制**（高优先级）
   - 为管理后台 API 添加权限验证
   - 实现基于角色的访问控制（RBAC）
   
2. **添加 API 速率限制**（中优先级）
   - 使用 @upstash/ratelimit 库
   - 防止 DDoS 攻击和滥用

3. **配置 CORS 白名单**（低优先级）
   - 明确允许的域名列表
   - 提高跨域安全性

4. **定期安全审计**
   - 每月运行 `pnpm audit`
   - 每季度进行代码审计
   - 每年进行渗透测试

## 项目状态
- **开发状态**: 已完成核心功能开发和安全修复
- **安全状态**: 已修复严重和高危漏洞，待实施建议措施
- **部署状态**: 已准备好本地部署文件和脚本
- **文档状态**: 已完成部署指南、安全清单和脚本说明

## 版本信息
- **当前版本**: v1.0.0
- **最后更新**: 2025-01-15
- **维护者**: 洛瓦托水泵选型系统团队
