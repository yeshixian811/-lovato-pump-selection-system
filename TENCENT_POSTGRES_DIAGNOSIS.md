# 🚨 腾讯云 PostgreSQL 连接诊断报告

## 📋 测试结果

### ❌ 连接测试失败

**测试时间：** 2025-02-10
**测试状态：** 失败

**错误信息：**
```
connect ETIMEDOUT 122.51.22.101:5432
```

**错误代码：** ETIMEDOUT

---

## 🔍 问题分析

### 可能的原因

#### 1️⃣ 数据库实例不存在或已停止
- ❌ IP 地址 `122.51.22.101` 可能不是您的腾讯云 PostgreSQL 实例地址
- ❌ 数据库实例可能已停止或已删除
- ❌ 端口 5432 可能未开放

#### 2️⃣ 网络连接问题
- ❌ 当前沙箱环境无法访问腾讯云数据库
- ❌ 防火墙阻止了连接
- ❌ 网络路由配置问题

#### 3️⃣ 安全组配置问题
- ❌ 安全组未允许沙箱环境 IP 访问
- ❌ 端口 5432 未在安全组中开放

---

## 🔧 解决方案

### 方案 1：确认腾讯云 PostgreSQL 实例信息

**步骤：**

1. **登录腾讯云控制台**
   ```
   https://console.cloud.tencent.com/postgres
   ```

2. **查看实例列表**
   - 进入 PostgreSQL 控制台
   - 查看您的实例列表
   - 确认实例状态是否为"运行中"

3. **获取正确的连接信息**
   - 点击实例名称进入详情页
   - 查看以下信息：
     - **内网地址**：类似 `10.x.x.x:5432`
     - **外网地址**：类似 `122.51.22.101:5432`
     - **数据库名**：`lovato_pump`
     - **用户名**：`lovato_user`
     - **密码**：`lovato_db_password_2024`

4. **检查实例状态**
   - 确认实例状态为"运行中"
   - 检查实例是否已过期

---

### 方案 2：配置安全组（如果外网访问）

**步骤：**

1. **进入安全组配置**
   - 在 PostgreSQL 实例详情页
   - 点击"安全组"标签
   - 点击"配置规则"

2. **添加入站规则**

   **规则 1：允许所有 IP 访问（仅用于测试）**
   ```
   类型: 自定义
   协议端口: TCP:5432
   来源: 0.0.0.0/0
   策略: 允许
   ```

   **规则 2：仅允许 Vercel IP 访问（生产环境推荐）**
   ```
   类型: 自定义
   协议端口: TCP:5432
   来源: 76.76.21.0/24
   策略: 允许

   类型: 自定义
   协议端口: TCP:5432
   来源: 76.76.19.0/24
   策略: 允许

   类型: 自定义
   协议端口: TCP:5432
   来源: 76.76.2.0/24
   策略: 允许

   类型: 自定义
   协议端口: TCP:5432
   来源: 76.76.27.0/24
   策略: 允许
   ```

---

### 方案 3：启用外网访问

**腾讯云 PostgreSQL 默认只提供内网访问，需要手动开启外网访问。**

**步骤：**

1. **在实例详情页**
   - 点击"访问管理"标签
   - 找到"开启外网访问"选项
   - 点击"开启"

2. **配置外网访问**
   - 选择需要开启外网访问的数据库
   - 设置访问密码（确保与配置一致）
   - 确认开启

3. **获取外网地址**
   - 开启成功后，会显示外网连接地址
   - 格式：`xxx.xxx.xxx.xxx:5432`

---

### 方案 4：验证实例是否真实存在

**方法 1：使用腾讯云 CLI 检查**

```bash
# 安装腾讯云 CLI
npm install -g @tencentcloud/cli

# 配置 CLI
tcloud configure set secret_id <您的SecretId>
tcloud configure set secret_key <您的SecretKey>
tcloud configure set region ap-guangzhou

# 查询 PostgreSQL 实例
tcloud postgres DescribeDBInstances
```

**方法 2：使用 ping 命令测试网络**

```bash
# 测试 IP 是否可达
ping -c 4 122.51.22.101

# 测试端口是否开放
telnet 122.51.22.101 5432
```

---

## 🎯 推荐方案

### 如果数据库实例不存在或已停止

**立即行动：**

1. **创建新的腾讯云 PostgreSQL 实例**
   - 登录腾讯云控制台
   - 进入 PostgreSQL 服务
   - 点击"新建实例"
   - 配置参数：
     - 版本：PostgreSQL 14
     - 可用区：广州（ap-guangzhou）或香港（ap-hongkong）
     - 规格：2核4GB（基础版）
     - 存储：100GB
     - 网络类型：私有网络
     - 数据库账号：lovato_user
     - 密码：lovato_db_password_2024

2. **创建数据库**
   - 在实例中创建数据库：`lovato_pump`

3. **开启外网访问**
   - 在访问管理中开启外网访问
   - 配置安全组允许访问

4. **获取连接信息**
   - 获取外网连接地址
   - 更新 `.env` 文件中的 `DATABASE_URL`

---

## 📊 当前配置信息

### 配置内容
```env
DATABASE_URL=postgresql://lovato_user:lovato_db_password_2024@122.51.22.101:5432/lovato_pump
```

### 连接参数
| 参数 | 值 |
|------|-----|
| 主机 | 122.51.22.101 |
| 端口 | 5432 |
| 数据库 | lovato_pump |
| 用户 | lovato_user |
| 密码 | lovato_db_password_2024 |
| SSL | 未配置 |

---

## ⚡ 快速检查清单

请逐一检查以下项目：

- [ ] 腾讯云 PostgreSQL 实例是否运行中？
- [ ] IP 地址 `122.51.22.101` 是否正确？
- [ ] 端口 `5432` 是否已开放？
- [ ] 用户名 `lovato_user` 是否存在？
- [ ] 密码 `lovato_db_password_2024` 是否正确？
- [ ] 数据库 `lovato_pump` 是否已创建？
- [ ] 外网访问是否已开启？
- [ ] 安全组是否已配置允许访问？
- [ ] 实例是否已过期？
- [ ] 账户余额是否充足？

---

## 🆘 联系支持

如果以上方案都无法解决问题：

1. **腾讯云技术支持**
   - 在线客服：https://console.cloud.tencent.com/workorder
   - 电话：95716

2. **提交工单**
   - 登录腾讯云控制台
   - 进入"工单管理"
   - 选择"PostgreSQL"服务
   - 提交技术支持工单

---

## 📝 总结

### 当前问题
- ❌ 数据库连接超时（ETIMEDOUT）
- ❌ 无法访问 IP 地址 `122.51.22.101:5432`

### 需要确认
1. 腾讯云 PostgreSQL 实例是否真实存在？
2. 实例状态是否为"运行中"？
3. 外网访问是否已开启？
4. 安全组是否已正确配置？

### 下一步行动
1. 登录腾讯云控制台，确认实例信息
2. 检查实例状态和网络配置
3. 开启外网访问（如果需要）
4. 配置安全组规则
5. 重新测试连接

---

**请在腾讯云控制台检查实例信息后，告诉我实际情况，我会帮您进一步配置。** 🚀
