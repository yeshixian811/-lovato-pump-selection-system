# ⚠️ 重要提示：当前环境说明

## 📍 当前环境状态

**当前位置**: Linux 开发沙箱环境
**环境类型**: 开发/演示环境
**PostgreSQL**: ❌ 未安装
**J 盘**: ❌ 未挂载
**适用性**: ❌ 不适合执行实际数据库迁移

---

## 🔍 为什么不能在当前环境执行？

当前环境是**开发沙箱**，主要用于开发和测试，不是生产服务器环境。

### 当前环境特点：
- ✅ 用于代码开发和测试
- ✅ 运行 Next.js 应用（端口 5000）
- ✅ 集成了各种开发工具
- ❌ 未安装 PostgreSQL 数据库服务器
- ❌ 没有挂载 J 盘
- ❌ 不是您实际的生产服务器

---

## 🎯 您需要在哪里执行迁移？

数据库迁移需要在**您的实际服务器**上执行，即：

### 如果您的数据库在 Windows 服务器上：
- 使用 RDP 远程桌面连接到您的 Windows 服务器
- 在服务器上运行 `scripts/windows/migrate-database-to-j-drive.bat`
- 服务器必须安装 PostgreSQL
- 服务器必须有 J 盘挂载

### 如果您的数据库在 Linux 服务器上：
- 使用 SSH 连接到您的 Linux 服务器
- 在服务器上运行 `scripts/migrate-database-to-j-drive.sh`
- 服务器必须安装 PostgreSQL
- 服务器必须有 J 盘挂载（通常挂载到 /mnt/j）

---

## 🚀 如何在您的服务器上执行迁移？

### 步骤 1: 确认您的服务器信息

```
请填写以下信息：
  服务器类型: [Windows / Linux]
  服务器IP/地址: _________________
  服务器用户名: _________________
  数据库版本: _________________
  J 盘状态: [已挂载 / 未挂载]
```

### 步骤 2: 连接到您的服务器

#### Windows 服务器
```
方法 1: RDP 远程桌面
  - 打开"远程桌面连接"
  - 输入服务器IP
  - 使用用户名和密码登录

方法 2: SSH（如果已启用）
  - 使用 SSH 客户端连接
  - ssh user@server-ip
```

#### Linux 服务器
```
使用 SSH 连接:
  ssh user@server-ip
  输入密码登录
```

### 步骤 3: 上传迁移脚本到服务器

#### 方法 A: 复制文件
```
将 scripts/ 目录（或 scripts/windows/ 目录）复制到服务器
例如复制到:
  Windows: C:\Scripts\postgresql-migration\
  Linux: ~/postgresql-migration/
```

#### 方法 B: 使用 SCP
```
# Linux 到 Linux
scp -r scripts/ user@server-ip:~/postgresql-migration/

# Windows 到 Linux
使用 WinSCP 或 FileZilla 上传文件
```

#### 方法 C: 使用 Git
```
# 如果文件在 Git 仓库中
git clone <your-repo-url>
cd <your-repo>
```

### 步骤 4: 在服务器上执行迁移

#### Windows 服务器
```batch
# 1. 打开命令提示符（管理员）
按 Win + X → 选择"命令提示符 (管理员)"

# 2. 进入脚本目录
cd C:\Scripts\postgresql-migration

# 3. 执行迁移
migrate-database-to-j-drive.bat

# 4. 等待完成（5-15分钟）

# 5. 验证结果
verify-migration.bat

# 6. 重启应用程序
net start nodejs-service
```

#### Linux 服务器
```bash
# 1. 进入脚本目录
cd ~/postgresql-migration

# 2. 赋予执行权限
chmod +x migrate-database-to-j-drive.sh
chmod +x verify-migration.sh

# 3. 确认 J 盘
df -h | grep j
# 如果未挂载，需要先挂载
sudo mkdir -p /mnt/j
sudo mount /dev/sdX1 /mnt/j  # 替换为实际设备

# 4. 执行迁移
sudo bash migrate-database-to-j-drive.sh

# 5. 等待完成（5-15分钟）

# 6. 验证结果
sudo bash verify-migration.sh

# 7. 重启应用程序
sudo systemctl restart nodejs-service
# 或
pm2 restart all
```

---

## 📋 服务器执行检查清单

在您的服务器上执行前，请确认：

### 通用检查
- [ ] 已连接到正确的服务器
- [ ] 有管理员/root 权限
- [ ] PostgreSQL 服务正在运行
- [ ] J 盘已挂载并可访问
- [ ] J 盘有足够空间（≥10GB）
- [ ] 已创建完整备份
- [ ] 已选择业务低峰期
- [ ] 相关人员已通知

### Windows 服务器额外检查
- [ ] 已安装 PostgreSQL
- [ ] 已检查服务名称（默认: postgresql-x64-14）
- [ ] 已检查安装路径（默认: C:\Program Files\PostgreSQL\14）
- [ ] 有 postgres 用户密码

### Linux 服务器额外检查
- [ ] 已安装 PostgreSQL
- [ ] 已检查服务名称（默认: postgresql）
- [ ] 已检查数据目录路径
- [ ] 有 postgres 用户密码

---

## 📊 执行流程时间线

```
┌─────────────────────────────────────────────┐
│  在您的服务器上执行迁移                      │
└─────────────────────────────────────────────┘

阶段 1: 准备（10-15分钟）
  ├─ 连接到服务器
  ├─ 上传脚本文件
  ├─ 检查环境
  └─ 创建备份

阶段 2: 执行（5-15分钟）
  ├─ 停止应用程序
  ├─ 停止 PostgreSQL
  ├─ 运行迁移脚本
  └─ 等待完成

阶段 3: 验证（2-3分钟）
  ├─ 运行验证脚本
  ├─ 检查验证结果
  └─ 确认无误

阶段 4: 恢复（2-3分钟）
  ├─ 启动 PostgreSQL
  ├─ 重启应用程序
  └─ 测试功能

总耗时: 19-36分钟
```

---

## ✅ 验证迁移成功

迁移成功后，您应该看到：

### Windows 服务器
```batch
[✓] 所有验证通过！迁移成功完成。

验证结果:
  通过项: 8
  失败项: 0
```

### Linux 服务器
```bash
[✓] 所有验证通过！迁移成功完成。

验证结果:
  通过项: 8
  失败项: 0
```

### 手动验证
```sql
-- 连接数据库
psql -U postgres -d lovato_pump

-- 查看版本
SELECT version();

-- 查看表
\dt

-- 检查数据
SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';

-- 退出
\q
```

---

## 🆘 需要帮助？

### 如果您不确定如何操作

1. **确认您的服务器信息**
   - 服务器类型（Windows/Linux）
   - 服务器地址
   - PostgreSQL 安装情况
   - J 盘状态

2. **查看详细文档**
   - `EXECUTE_ON_SERVER.md` - 服务器执行指南
   - `MIGRATION_EXECUTION_GUIDE.md` - 详细步骤
   - `MIGRATION_CHECKLIST.md` - 检查清单

3. **按照步骤执行**
   - 一步一步执行
   - 不要跳过任何步骤
   - 记录执行过程

---

## 📝 执行记录模板

请在执行时填写：

```
数据库迁移执行记录
==================

服务器信息:
  服务器类型: [Windows / Linux]
  服务器地址: _________________
  用户名: _________________
  数据库版本: _________________
  J 盘状态: _________________

执行信息:
  开始时间: _________________
  结束时间: _________________
  总耗时: _________________
  执行人员: _________________

备份信息:
  备份位置: _________________
  备份文件: _________________
  备份大小: _________________

执行过程:
  阶段1（准备）: [完成时间]
  阶段2（迁移）: [完成时间]
  阶段3（验证）: [完成时间]
  阶段4（恢复）: [完成时间]

验证结果:
  服务状态: [通过 / 失败]
  数据目录: [通过 / 失败]
  数据连接: [通过 / 失败]
  数据完整: [通过 / 失败]
  应用运行: [通过 / 失败]

问题记录:
  无问题: [ ] 是  [ ] 否
  问题描述: _________________
  解决方案: _________________

确认签名: _________________
日期: _________________
```

---

## 🎯 现在该怎么做？

### 立即行动

1. **确认您的服务器**
   - 您的服务器在哪里？
   - 是 Windows 还是 Linux？
   - 数据库在哪里？

2. **连接到服务器**
   - 使用 RDP（Windows）
   - 使用 SSH（Linux）

3. **上传脚本文件**
   - 复制 scripts/ 目录到服务器
   - 或使用 SCP/Git

4. **执行迁移**
   - 按照上述步骤执行
   - 记录执行过程
   - 验证迁移结果

---

## ❓ 常见问题

**Q: 我可以在当前开发环境执行吗？**
A: 不可以。当前是开发沙箱，没有 PostgreSQL 和 J 盘。需要在您的实际服务器上执行。

**Q: 我不知道我的服务器信息？**
A: 请联系您的系统管理员或查看您的服务器托管信息。

**Q: 我需要什么权限？**
A: 需要 Administrator/root 权限来执行迁移。

**Q: 迁移会丢失数据吗？**
A: 不会。迁移脚本会自动创建完整备份，确保数据安全。

**Q: 如果迁移失败怎么办？**
A: 使用回滚方案（参考文档）恢复到迁移前的状态。

---

## 📞 获取支持

如果您在执行过程中遇到问题：

1. **查看日志**
   - Windows: `J:\postgresql\data\log\postgresql-*.log`
   - Linux: `/var/log/postgresql/postgresql-*.log`

2. **查看验证报告**
   - 运行验证脚本查看详细结果

3. **参考回滚方案**
   - 如果迁移失败，立即执行回滚

4. **联系技术支持**
   - 提供错误日志
   - 描述执行步骤
   - 说明当前状态

---

**重要**: 数据库迁移必须在您的**实际服务器**上执行，不能在当前开发沙箱中执行。请按照上述步骤连接到您的服务器并执行迁移。
