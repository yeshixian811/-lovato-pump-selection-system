# 数据库迁移到J盘 - 执行检查表

请打印此检查表并在执行时逐项勾选。

---

## 📋 服务器信息（请填写）

```
服务器类型: [□ Windows  □ Linux]
服务器地址: _____________________________
用户名: _____________________________
数据库版本: _____________________________
J 盘状态: [□ 已挂载  □ 需要挂载]
```

---

## ✅ 执行前检查（必须全部勾选）

### 环境检查
- [ ] 已连接到正确的服务器
- [ ] 已以管理员/root 身份登录
- [ ] PostgreSQL 服务正在运行
- [ ] J 盘已挂载并可访问
- [ ] J 盘有足够空间（≥10GB）

### 文件检查
- [ ] 迁移脚本已准备
  - Windows: `migrate-database-to-j-drive.bat`
  - Linux: `migrate-database-to-j-drive.sh`
- [ ] 验证脚本已准备
  - Windows: `verify-migration.bat`
  - Linux: `verify-migration.sh`
- [ ] 已阅读执行指南
- [ ] 已准备回滚方案

### 备份检查
- [ ] 已创建完整数据库备份
- [ ] 备份文件已验证
- [ ] 备份文件已复制到安全位置
- [ ] 配置文件已备份

### 业务准备
- [ ] 已选择业务低峰期
- [ ] 相关人员已通知
- [ ] 应用程序已准备停止
- [ ] 有充足的执行时间（30分钟）

---

## 🚀 执行步骤（按顺序执行）

### 阶段 1: 准备阶段

#### Windows 服务器
- [ ] 打开命令提示符（管理员）
- [ ] 进入脚本目录
- [ ] 执行: `dir J:\`
- [ ] 执行: `wmic logicaldisk where "DeviceID='J:'" get FreeSpace,Size`
- [ ] 执行: `sc query postgresql-x64-14`

#### Linux 服务器
- [ ] 打开终端
- [ ] 进入脚本目录
- [ ] 执行: `df -h | grep j`
- [ ] 执行: `sudo systemctl status postgresql`

### 阶段 2: 创建备份

#### Windows 服务器
- [ ] 创建备份目录: `mkdir J:\postgresql\backups`
- [ ] 执行备份命令
- [ ] 验证备份文件存在
- [ ] 记录备份文件路径: _____________________

#### Linux 服务器
- [ ] 创建备份目录: `sudo mkdir -p /mnt/j/postgresql/backups`
- [ ] 执行备份命令
- [ ] 验证备份文件存在
- [ ] 记录备份文件路径: _____________________

### 阶段 3: 停止服务

#### Windows 服务器
- [ ] 停止应用程序: `net stop nodejs-service`
- [ ] 停止 PostgreSQL: `net stop postgresql-x64-14`
- [ ] 验证服务已停止: `sc query postgresql-x64-14`

#### Linux 服务器
- [ ] 停止应用程序: `sudo systemctl stop nodejs-service` 或 `pm2 stop all`
- [ ] 停止 PostgreSQL: `sudo systemctl stop postgresql`
- [ ] 验证服务已停止: `sudo systemctl status postgresql`

### 阶段 4: 执行迁移

#### Windows 服务器
- [ ] 执行: `migrate-database-to-j-drive.bat`
- [ ] 等待迁移完成
- [ ] 检查迁移输出是否有错误
- [ ] 记录迁移耗时: _____________________ 分钟

#### Linux 服务器
- [ ] 执行: `sudo bash migrate-database-to-j-drive.sh`
- [ ] 等待迁移完成
- [ ] 检查迁移输出是否有错误
- [ ] 记录迁移耗时: _____________________ 分钟

### 阶段 5: 验证迁移

#### Windows 服务器
- [ ] 执行: `sc query postgresql-x64-14`
- [ ] 执行: `dir J:\postgresql\data`
- [ ] 执行: `verify-migration.bat`
- [ ] 检查验证结果:
  - 通过项: _____
  - 失败项: _____

#### Linux 服务器
- [ ] 执行: `sudo systemctl status postgresql`
- [ ] 执行: `ls -la /mnt/j/postgresql/data`
- [ ] 执行: `sudo bash verify-migration.sh`
- [ ] 检查验证结果:
  - 通过项: _____
  - 失败项: _____

### 阶段 6: 数据库测试

- [ ] 连接到数据库
  - Windows: `psql -U postgres -d lovato_pump`
  - Linux: `sudo -u postgres psql -d lovato_pump`
- [ ] 执行: `SELECT version();`
- [ ] 执行: `\dt`
- [ ] 执行: `SELECT count(*) FROM information_schema.tables WHERE table_schema = 'public';`
- [ ] 检查表数量: _____ （记录数量）
- [ ] 退出: `\q`

### 阶段 7: 重启应用

#### Windows 服务器
- [ ] 启动应用程序: `net start nodejs-service`
- [ ] 验证应用运行: 访问 http://localhost:5000

#### Linux 服务器
- [ ] 启动应用程序: `sudo systemctl start nodejs-service` 或 `pm2 start all`
- [ ] 验证应用运行: 访问 http://localhost:5000

### 阶段 8: 功能测试

- [ ] 测试应用程序主页
- [ ] 测试用户登录功能
- [ ] 测试数据查询功能
- [ ] 测试数据写入功能
- [ ] 检查应用程序日志
- [ ] 浏览器控制台无错误

---

## 📊 执行结果

```
开始时间: _______________________
结束时间: _______________________
总耗时: _______________________ 分钟

验证结果:
  服务状态: [□ 通过  □ 失败]
  数据目录: [□ 通过  □ 失败]
  数据连接: [□ 通过  □ 失败]
  数据完整: [□ 通过  □ 失败]
  应用运行: [□ 通过  □ 失败]
  功能测试: [□ 通过  □ 失败]

总体结果: [□ 成功  □ 失败]
```

---

## 🆘 问题记录

```
是否遇到问题: [□ 否  □ 是]

如果遇到问题:
  问题描述: ________________________________________
  ________________________________________________
  ________________________________________________

  解决方案: ________________________________________
  ________________________________________________
  ________________________________________________

  是否解决: [□ 是  □ 否]
```

---

## 🔄 回滚（如果需要）

```
是否需要回滚: [□ 否  □ 是]

回滚步骤:
  [ ] 停止服务
  [ ] 恢复原始配置
  [ ] 恢复数据（如需要）
  [ ] 启动服务
  [ ] 验证服务运行
  [ ] 通知相关人员

回滚结果: [□ 成功  □ 失败]
```

---

## 📝 备注

```
备注:
________________________________________________
________________________________________________
________________________________________________
________________________________________________
```

---

## ✅ 完成确认

```
执行人员: _______________________
执行日期: _______________________
确认签名: _______________________

需要后续处理:
[□ 清理旧数据目录]
[□ 更新文档]
[□ 更新监控配置]
[□ 通知团队成员]
[□ 无需处理]
```

---

## 📞 紧急联系

```
系统管理员: _______________________
数据库管理员: _______________________
应用开发: _______________________
其他: _______________________
```

---

**检查表使用说明**:
1. 在执行前打印此检查表
2. 每完成一项勾选一个方框
3. 记录所有重要信息
4. 如有问题，记录在问题记录部分
5. 执行完成后，填写执行结果
6. 保留此检查表作为记录

**祝迁移顺利！** 🚀
