# 洛瓦托水泵选型系统 - 完整规格书

**版本**: v1.0.0  
**日期**: 2026-02-13  
**开发语言**: TypeScript  
**框架**: Next.js 16.1.1

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [系统架构](#3-系统架构)
4. [功能模块](#4-功能模块)
5. [核心代码](#5-核心代码)
6. [API 接口](#6-api-接口)
7. [数据库设计](#7-数据库设计)
8. [部署指南](#8-部署指南)

---

## 1. 项目概述

### 1.1 项目信息

| 项目 | 信息 |
|------|------|
| 项目名称 | 洛瓦托水泵选型系统 |
| 版本 | v1.0.0 |
| 开发语言 | TypeScript |
| 前端框架 | Next.js 16.1.1 (React 19) |
| 后端框架 | Next.js API Routes |
| 数据库 | PostgreSQL (火山云 RDS) |
| UI 组件库 | shadcn/ui (基于 Radix UI) |
| 样式方案 | Tailwind CSS 4 |

### 1.2 项目目标

构建一个智能水泵选型系统，帮助用户根据使用需求快速匹配最合适的水泵产品。

### 1.3 核心功能

- ✅ 智能选型（根据流量、扬程、应用类型等参数匹配）
- ✅ 产品库管理（查看、搜索、筛选产品）
- ✅ 用户注册登录
- ✅ 管理后台（用户管理、产品管理）

---

## 2. 技术架构

### 2.1 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Next.js | 16.1.1 | 全栈框架 |
| React | 19.2.3 | 前端框架 |
| TypeScript | 5.x | 开发语言 |
| Tailwind CSS | 4 | 样式方案 |
| shadcn/ui | Latest | UI 组件库 |
| Drizzle ORM | Latest | 数据库 ORM |
| PostgreSQL | 14+ | 数据库 |
| Recharts | Latest | 图表库（性能曲线） |

### 2.2 目录结构

```
.
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/               # API 路由
│   │   │   ├── auth/         # 认证相关
│   │   │   ├── pumps/        # 水泵相关
│   │   │   ├── pump/         # 智能选型
│   │   │   ├── inventory/    # 库存相关
│   │   │   ├── admin/        # 管理后台
│   │   │   ├── user/         # 用户管理
│   │   │   └── website/      # 网站内容
│   │   ├── products/          # 产品库页面
│   │   ├── selection/         # 智能选型页面
│   │   ├── admin/             # 管理后台页面
│   │   ├── auth/              # 认证页面
│   │   └── page.tsx           # 首页
│   ├── components/            # React 组件
│   │   └── ui/               # shadcn/ui 组件
│   ├── storage/              # 数据存储
│   │   └── database/         # 数据库相关
│   │       ├── shared/       # 共享 schema
│   │       ├── userManager.ts # 用户管理
│   │       └── pumpManager.ts # 水泵管理
│   └── lib/                  # 工具函数
├── public/                   # 静态资源
├── drizzle.config.ts         # Drizzle 配置
├── next.config.ts            # Next.js 配置
├── package.json              # 依赖配置
├── tsconfig.json             # TypeScript 配置
└── .env                      # 环境变量
```

---

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                          │
│              (Next.js React 前端应用)                   │
└──────────────────────┬──────────────────────────────────┘
                       │
                       │ HTTP/HTTPS
                       │
┌──────────────────────▼──────────────────────────────────┐
│                  Next.js 服务器                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │              API Routes (后端)                  │   │
│  │  ├─ /api/auth/* (认证)                         │   │
│  │  ├─ /api/pumps/* (水泵管理)                    │   │
│  │  ├─ /api/pump/match (智能选型)                 │   │
│  │  ├─ /api/admin/* (管理后台)                    │   │
│  │  └─ /api/user/* (用户管理)                     │   │
│  └──────────────────┬──────────────────────────────┘   │
│                     │                                     │
│  ┌──────────────────▼──────────────────────────────┐   │
│  │              数据访问层                          │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │         Drizzle ORM                      │   │   │
│  │  │  ┌───────────────────────────────────┐  │   │   │
│  │  │  │    PostgreSQL Connection Pool     │  │   │   │
│  │  │  └──────────────┬────────────────────┘  │   │   │
│  │  └─────────────────┼────────────────────────┘   │   │
│  └────────────────────┼────────────────────────────┘   │
└───────────────────────┼────────────────────────────────┘
                        │
                        │ TCP
                        │
┌───────────────────────▼────────────────────────────────┐
│              火山云 PostgreSQL RDS                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   数据库                         │   │
│  │  ├─ users (用户表)                             │   │
│  │  ├─ pumps (水泵表)                             │   │
│  │  ├─ pumpPerformancePoints (性能曲线)          │   │
│  │  ├─ subscriptions (订阅表)                     │   │
│  │  ├─ emailVerifications (邮箱验证)              │   │
│  │  └─ passwordResets (密码重置)                  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 3.2 数据流程图

#### 3.2.1 智能选型流程

```
用户输入参数
    │
    ├─ 流量需求 (m³/h)
    ├─ 扬程需求 (m)
    ├─ 应用类型
    ├─ 流体类型
    └─ 水泵类型 (可选)
    │
    ▼
前端提交到 /api/pump/match
    │
    ▼
后端接收参数
    │
    ├─ 验证参数有效性
    ├─ 查询数据库获取所有水泵
    ├─ 计算匹配度
    │   ├─ 流量匹配度 (目标: 5%-20% 余量)
    │   ├─ 扬程匹配度 (目标: 5%-15% 余量)
    │   ├─ 应用类型匹配
    │   ├─ 流体类型匹配
    │   └─ 水泵类型匹配
    ├─ 按匹配度排序
    └─ 返回匹配结果
    │
    ▼
前端显示选型结果
    │
    ├─ 显示产品列表
    ├─ 显示匹配度
    ├─ 显示性能曲线图
    └─ 显示推荐理由
```

---

## 4. 功能模块

### 4.1 智能选型模块

#### 功能描述
根据用户输入的流量、扬程、应用类型等参数，智能匹配最合适的水泵产品。

#### 前端代码路径
`src/app/selection/page.tsx`

#### 后端 API
`src/app/api/pump/match/route.ts`

#### 匹配算法（参考格兰富选型算法）

```
总分数: 100分

1. 连续运行范围检查 (20分)
   - 需求流量必须在 [minFlow, maxFlow] 范围内
   - 满足: 20分
   - 不满足: 0分

2. 扬程匹配度 (35分)
   - 计算需求流量处的曲线扬程
   - 曲线扬程必须 >= 需求扬程
   - 评分标准:
     * 扬程余量 0-5%: 35分 (最佳)
     * 扬程余量 5-10%: 33分 (优秀)
     * 扬程余量 10-20%: 30分 (良好)
     * 扬程余量 20-30%: 22分 (可用)
     * 扬程余量 30-50%: 12分 (勉强)
     * 扬程余量 >50%: 5分 (不推荐)

3. 最佳效率区间 (35分)
   - 格兰富最佳效率区间 (BEP): 最大流量的 60%-120%
   - 评分标准:
     * 在最佳效率区间内: 35分 (最佳)
     * 在允许运行区间内: 28分 (良好)
     * 在边缘运行区间: 18分 (可用)
     * 超出推荐范围: 8分 (勉强)

4. 效率值 (10分)
   - 效率 >= 80%: 10分 (优秀)
   - 效率 >= 75%: 8分 (良好)
   - 效率 >= 65%: 5分 (可用)
   - 效率 < 65%: 2分 (偏低)

5. 应用场景匹配 (+5分)
   - 匹配: +5分
   - 不匹配: 0分

6. 流体类型匹配 (+3分)
   - 匹配: +3分
   - 不匹配: 0分

总分 = 20 + 35 + 35 + 10 + 5 + 3 = 108分
```

---

### 4.2 产品库模块

#### 功能描述
查看、搜索、筛选、管理水泵产品。

#### 前端代码路径
`src/app/products/page.tsx`

#### 后端 API
- `src/app/api/pumps/route.ts` - 列表和创建
- `src/app/api/pumps/[id]/route.ts` - 详情、更新、删除
- `src/app/api/pumps/[id]/performance/route.ts` - 性能曲线

---

### 4.3 认证模块

#### 功能描述
用户注册、登录、邮箱验证、密码重置。

#### 前端组件
- 注册页面: `src/app/auth/register/page.tsx`
- 登录页面: `src/app/auth/login/page.tsx`

#### 后端 API
- `src/app/api/auth/register/route.ts`
- `src/app/api/auth/login/route.ts`
- `src/app/api/auth/logout/route.ts`
- `src/app/api/auth/verify-email/route.ts`
- `src/app/api/auth/reset-password/route.ts`

---

### 4.4 管理后台模块

#### 功能描述
用户管理、产品管理、系统监控。

#### 前端代码路径
- 用户管理: `src/app/admin/users/page.tsx`
- 产品管理: `src/app/admin/products/page.tsx`
- 系统监控: `src/app/admin/dashboard/page.tsx`

#### 后端 API
- `src/app/api/admin/users/route.ts`
- `src/app/api/admin/system/stats/route.ts`
- `src/app/api/admin/database/status/route.ts`

---

## 5. 核心代码

### 5.1 智能选型 API

**文件路径**: `src/app/api/pump/match/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { pumpManager } from '@/storage/database/pumpManager';

interface SelectionParams {
  required_flow_rate: number;
  required_head: number;
  application_type: string;
  fluid_type: string;
  pump_type: string;
  preferred_power?: number; // 可选参数
}

// 计算水泵性能曲线上的扬程
// 使用二次曲线模型：H = shutOffHead - k * Q^2
function calculateHeadAtFlow(pump: any, flowRate: number): number {
  const maxHead = parseFloat(pump.max_head);
  const maxFlow = parseFloat(pump.max_flow_rate);

  // 关断点扬程（流量为0时的扬程），通常是最大扬程的1.2-1.3倍
  const shutOffHead = maxHead * 1.25;

  // 计算曲线系数
  const k = shutOffHead / Math.pow(maxFlow, 2);

  // 计算指定流量下的扬程
  const head = shutOffHead - k * Math.pow(flowRate, 2);

  // 确保扬程不为负
  return Math.max(0, head);
}

// 匹配度计算函数 - 参考格兰富选型算法
function calculateMatchScore(
  pump: any,
  params: SelectionParams
): number {
  let score = 0;
  const maxScore = 100;

  const requiredFlow = params.required_flow_rate;
  const requiredHead = params.required_head;
  
  const maxFlow = parseFloat(pump.max_flow_rate);
  const minFlow = parseFloat(pump.min_flow_rate || maxFlow * 0.3);
  const maxHead = parseFloat(pump.max_head);
  const minHead = parseFloat(pump.min_head || maxHead * 0.6);
  const efficiency = parseFloat(pump.efficiency);

  // 步骤1：检查需求点是否在连续运行范围内
  if (requiredFlow < minFlow || requiredFlow > maxFlow) {
    return 0;
  }
  score += 20;

  // 步骤2：计算需求流量处的性能曲线扬程
  const curveHead = calculateHeadAtFlow(pump, requiredFlow);
  
  // 步骤3：性能曲线必须满足扬程要求
  if (curveHead < requiredHead) {
    return 0;
  }
  
  // 步骤4：评估扬程匹配度（权重: 35%）
  const headRatio = curveHead / requiredHead;
  
  if (headRatio <= 1.05) {
    score += 35;
  } else if (headRatio <= 1.10) {
    score += 33;
  } else if (headRatio <= 1.20) {
    score += 30;
  } else if (headRatio <= 1.30) {
    score += 22;
  } else if (headRatio <= 1.50) {
    score += 12;
  } else {
    score += 5;
  }

  // 步骤5：评估工作点是否在最佳效率区间（权重: 35%）
  if (maxFlow > 0) {
    const flowRatio = requiredFlow / maxFlow;
    
    if (flowRatio >= 0.6 && flowRatio <= 1.2) {
      score += 35;
    } else if (flowRatio >= 0.5 && flowRatio <= 1.3) {
      score += 28;
    } else if (flowRatio >= 0.4 && flowRatio <= 1.4) {
      score += 18;
    } else {
      score += 8;
    }
  } else {
    score += 20;
  }

  // 步骤6：效率值评分（权重: 10%）
  if (efficiency >= 80) {
    score += 10;
  } else if (efficiency >= 75) {
    score += 8;
  } else if (efficiency >= 65) {
    score += 5;
  } else {
    score += 2;
  }

  // 步骤7：应用场景匹配（额外加分: +5分）
  const pumpApplications = pump.applications || [];
  const pumpApplication = pump.application_type || pump.applicationType;
  
  if (pumpApplications.includes(params.application_type) || 
      pumpApplication === params.application_type) {
    score += 5;
  }

  // 步骤8：流体类型匹配（额外加分: +3分）
  const pumpFluidTypes = pump.fluid_types || [];
  
  if (pumpFluidTypes.includes(params.fluid_type) ||
      pumpFluidTypes.includes('清水') && params.fluid_type.includes('水')) {
    score += 3;
  }

  return Math.min(score, maxScore);
}

export async function POST(request: NextRequest) {
  try {
    const body: SelectionParams = await request.json();
    
    // 验证参数
    if (!body.required_flow_rate || !body.required_head) {
      return NextResponse.json(
        { error: '缺少必需参数' },
        { status: 400 }
      );
    }

    // 获取所有水泵
    const pumps = await pumpManager.getAllPumps();
    
    // 计算每个水泵的匹配度
    const scoredPumps = pumps.map(pump => ({
      ...pump,
      match_score: calculateMatchScore(pump, body)
    }));

    // 过滤掉匹配度为0的水泵
    const matchedPumps = scoredPumps.filter(pump => pump.match_score > 0);

    // 按匹配度降序排序
    matchedPumps.sort((a, b) => b.match_score - a.match_score);

    // 返回前10个匹配结果
    const results = matchedPumps.slice(0, 10);

    return NextResponse.json({
      pumps: results,
      total: results.length.toString(),
      selection_params: body
    });
  } catch (error) {
    console.error('选型失败:', error);
    return NextResponse.json(
      { error: '选型失败', message: (error as Error).message },
      { status: 500 }
    );
  }
}
```

---

### 5.2 水泵管理 API

**文件路径**: `src/app/api/pumps/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { pumpManager } from "@/storage/database";

// GET /api/pumps - 获取水泵列表
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '10');
    const search = searchParams.get('search') || '';
    const type = searchParams.get('type') || '';

    const result = await pumpManager.getPumps({
      page,
      limit,
      search,
      type
    });

    return NextResponse.json(result);
  } catch (error) {
    console.error('获取水泵列表失败:', error);
    return NextResponse.json(
      { error: '获取水泵列表失败' },
      { status: 500 }
    );
  }
}

// POST /api/pumps - 创建水泵
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const pump = await pumpManager.createPump(body);
    
    return NextResponse.json(pump, { status: 201 });
  } catch (error) {
    console.error('创建水泵失败:', error);
    return NextResponse.json(
      { error: '创建水泵失败' },
      { status: 500 }
    );
  }
}
```

---

### 5.3 用户认证 API

**文件路径**: `src/app/api/auth/login/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/storage/database/userManager';
import { users } from '@/storage/database/shared/schema';
import { eq } from 'drizzle-orm';
import bcrypt from 'bcryptjs';

export async function POST(request: NextRequest) {
  try {
    const { email, password } = await request.json();

    // 查找用户
    const userResult = await db
      .select()
      .from(users)
      .where(eq(users.email, email))
      .limit(1);

    if (userResult.length === 0) {
      return NextResponse.json(
        { error: '用户不存在' },
        { status: 401 }
      );
    }

    const user = userResult[0];

    // 验证密码
    const isValid = await bcrypt.compare(password, user.passwordHash);

    if (!isValid) {
      return NextResponse.json(
        { error: '密码错误' },
        { status: 401 }
      );
    }

    // 返回用户信息（不包含密码）
    const { passwordHash, ...userWithoutPassword } = user;

    return NextResponse.json({
      user: userWithoutPassword,
      token: 'your-jwt-token' // 实际应用中应该生成 JWT token
    });
  } catch (error) {
    console.error('登录失败:', error);
    return NextResponse.json(
      { error: '登录失败' },
      { status: 500 }
    );
  }
}
```

---

### 5.4 数据库 Schema

**文件路径**: `src/storage/database/shared/schema.ts`

```typescript
import { sql } from "drizzle-orm";
import {
  pgTable,
  text,
  varchar,
  timestamp,
  integer,
  decimal,
  index,
  jsonb,
  boolean,
  uuid,
  pgEnum,
} from "drizzle-orm/pg-core";

// 用户角色枚举
export const userRoleEnum = pgEnum('user_role', ['user', 'admin']);

// 用户表
export const users = pgTable(
  "users",
  {
    id: uuid("id")
      .primaryKey()
      .default(sql`gen_random_uuid()`),
    email: varchar("email", { length: 255 }).notNull().unique(),
    passwordHash: varchar("password_hash", { length: 255 }).notNull(),
    name: varchar("name", { length: 255 }),
    role: userRoleEnum("role").notNull().default('user'),
    emailVerified: boolean("email_verified").notNull().default(false),
    createdAt: timestamp("created_at", { withTimezone: true })
      .defaultNow()
      .notNull(),
    updatedAt: timestamp("updated_at", { withTimezone: true })
      .defaultNow()
      .notNull(),
  },
  (table) => ({
    emailIdx: index("users_email_idx").on(table.email),
  })
);

// 水泵表
export const pumps = pgTable(
  "pumps",
  {
    id: uuid("id")
      .primaryKey()
      .default(sql`gen_random_uuid()`),
    model: varchar("model", { length: 100 }).notNull(),
    name: varchar("name", { length: 255 }).notNull(),
    brand: varchar("brand", { length: 100 }).notNull(),
    type: varchar("type", { length: 50 }).notNull(),
    series: varchar("series", { length: 50 }),
    description: text("description"),
    max_flow_rate: decimal("max_flow_rate", { precision: 10, scale: 2 }).notNull(),
    min_flow_rate: decimal("min_flow_rate", { precision: 10, scale: 2 }),
    max_head: decimal("max_head", { precision: 10, scale: 2 }).notNull(),
    min_head: decimal("min_head", { precision: 10, scale: 2 }),
    rated_power: decimal("rated_power", { precision: 10, scale: 2 }).notNull(),
    rated_speed: integer("rated_speed"),
    efficiency: decimal("efficiency", { precision: 5, scale: 2 }),
    voltage: varchar("voltage", { length: 20 }),
    frequency: integer("frequency"),
    current: decimal("current", { precision: 10, scale: 2 }),
    power_factor: decimal("power_factor", { precision: 5, scale: 3 }),
    inlet_diameter: integer("inlet_diameter"),
    outlet_diameter: integer("outlet_diameter"),
    weight: decimal("weight", { precision: 10, scale: 2 }),
    dimensions: varchar("dimensions", { length: 100 }),
    casing_material: varchar("casing_material", { length: 50 }),
    impeller_material: varchar("impeller_material", { length: 50 }),
    seal_type: varchar("seal_type", { length: 50 }),
    protection_level: varchar("protection_level", { length: 10 }),
    insulation_class: varchar("insulation_class", { length: 10 }),
    applications: jsonb("applications").$type<string[]>(),
    fluid_types: jsonb("fluid_types").$type<string[]>(),
    max_temperature: integer("max_temperature"),
    min_temperature: integer("min_temperature"),
    max_viscosity: decimal("max_viscosity", { precision: 10, scale: 2 }),
    price: decimal("price", { precision: 12, scale: 2 }),
    currency: varchar("currency", { length: 10 }),
    in_stock: boolean("in_stock").notNull().default(true),
    stock_quantity: integer("stock_quantity"),
    image_url: varchar("image_url", { length: 500 }),
    spec_sheet_url: varchar("spec_sheet_url", { length: 500 }),
    manual_url: varchar("manual_url", { length: 500 }),
    createdAt: timestamp("created_at", { withTimezone: true })
      .defaultNow()
      .notNull(),
    updatedAt: timestamp("updated_at", { withTimezone: true })
      .defaultNow()
      .notNull(),
  },
  (table) => ({
    modelIdx: index("pumps_model_idx").on(table.model),
  })
);

// 性能曲线点表
export const pumpPerformancePoints = pgTable(
  "pump_performance_points",
  {
    id: uuid("id")
      .primaryKey()
      .default(sql`gen_random_uuid()`),
    pumpId: uuid("pump_id").notNull().references(() => pumps.id, { onDelete: "cascade" }),
    flowRate: decimal("flow_rate", { precision: 10, scale: 2 }).notNull(),
    head: decimal("head", { precision: 10, scale: 2 }).notNull(),
    power: decimal("power", { precision: 10, scale: 2 }),
    efficiency: decimal("efficiency", { precision: 5, scale: 2 }),
    createdAt: timestamp("created_at", { withTimezone: true })
      .defaultNow()
      .notNull(),
  },
  (table) => ({
    pumpIdIdx: index("pump_performance_points_pump_id_idx").on(table.pumpId),
    flowRateIdx: index("pump_performance_points_flow_rate_idx").on(table.flowRate),
  })
);
```

---

## 6. API 接口

### 6.1 智能选型 API

#### POST /api/pump/match

**描述**: 根据用户需求智能匹配水泵

**请求体**:
```json
{
  "required_flow_rate": 50,
  "required_head": 20,
  "application_type": "暖通空调",
  "fluid_type": "清水",
  "pump_type": "centrifugal",
  "preferred_power": 5.5
}
```

**响应**:
```json
{
  "pumps": [
    {
      "id": "uuid",
      "model": "LOV-50-125",
      "name": "洛瓦托离心泵 50-125",
      "match_score": 95,
      "max_flow_rate": 50,
      "max_head": 20,
      "performance_curve": [...]
    }
  ],
  "total": "1",
  "selection_params": {...}
}
```

---

### 6.2 水泵管理 API

#### GET /api/pumps

**描述**: 获取水泵列表

**查询参数**:
- `page`: 页码 (默认: 1)
- `limit`: 每页数量 (默认: 10)
- `search`: 搜索关键词
- `type`: 产品类型

**响应**:
```json
{
  "pumps": [...],
  "total": "100",
  "page": "1",
  "limit": "10"
}
```

#### GET /api/pumps/[id]

**描述**: 获取单个水泵详情

**响应**:
```json
{
  "id": "uuid",
  "model": "LOV-50-125",
  "name": "洛瓦托离心泵 50-125",
  "max_flow_rate": 50,
  "max_head": 20,
  ...
}
```

#### POST /api/pumps

**描述**: 创建新的水泵

**请求体**: 水泵完整信息

**响应**: 创建的水泵对象

#### PUT /api/pumps/[id]

**描述**: 更新水泵信息

**请求体**: 要更新的字段

**响应**: 更新后的水泵对象

#### DELETE /api/pumps/[id]

**描述**: 删除水泵

**响应**:
```json
{
  "success": true
}
```

---

### 6.3 用户认证 API

#### POST /api/auth/register

**描述**: 用户注册

**请求体**:
```json
{
  "email": "user@example.com",
  "password": "password123",
  "name": "用户名"
}
```

**响应**:
```json
{
  "user": {...},
  "token": "jwt-token"
}
```

#### POST /api/auth/login

**描述**: 用户登录

**请求体**:
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**响应**:
```json
{
  "user": {...},
  "token": "jwt-token"
}
```

---

## 7. 数据库设计

### 7.1 数据库表结构

#### users (用户表)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | uuid | 用户ID | 主键 |
| email | varchar(255) | 邮箱 | 唯一, 非空 |
| passwordHash | varchar(255) | 密码哈希 | 非空 |
| name | varchar(255) | 用户名 | |
| role | enum | 角色 | 'user', 'admin' |
| emailVerified | boolean | 邮箱验证 | 默认: false |
| createdAt | timestamp | 创建时间 | 默认: now() |
| updatedAt | timestamp | 更新时间 | 默认: now() |

---

#### pumps (水泵表)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | uuid | 水泵ID | 主键 |
| model | varchar(100) | 型号 | 非空 |
| name | varchar(255) | 名称 | 非空 |
| brand | varchar(100) | 品牌 | 非空 |
| type | varchar(50) | 类型 | 非空 |
| series | varchar(50) | 系列 | |
| description | text | 描述 | |
| max_flow_rate | decimal(10,2) | 最大流量 | 非空 |
| min_flow_rate | decimal(10,2) | 最小流量 | |
| max_head | decimal(10,2) | 最大扬程 | 非空 |
| min_head | decimal(10,2) | 最小扬程 | |
| rated_power | decimal(10,2) | 额定功率 | 非空 |
| rated_speed | integer | 额定转速 | |
| efficiency | decimal(5,2) | 效率 | |
| voltage | varchar(20) | 电压 | |
| frequency | integer | 频率 | |
| current | decimal(10,2) | 电流 | |
| power_factor | decimal(5,3) | 功率因数 | |
| inlet_diameter | integer | 进口直径 | |
| outlet_diameter | integer | 出口直径 | |
| weight | decimal(10,2) | 重量 | |
| dimensions | varchar(100) | 尺寸 | |
| casing_material | varchar(50) | 泵壳材质 | |
| impeller_material | varchar(50) | 叶轮材质 | |
| seal_type | varchar(50) | 密封类型 | |
| protection_level | varchar(10) | 防护等级 | |
| insulation_class | varchar(10) | 绝缘等级 | |
| applications | jsonb | 应用场景 | |
| fluid_types | jsonb | 流体类型 | |
| max_temperature | integer | 最高温度 | |
| min_temperature | integer | 最低温度 | |
| max_viscosity | decimal(10,2) | 最大粘度 | |
| price | decimal(12,2) | 价格 | |
| currency | varchar(10) | 货币 | |
| in_stock | boolean | 是否有货 | 默认: true |
| stock_quantity | integer | 库存数量 | |
| image_url | varchar(500) | 图片URL | |
| spec_sheet_url | varchar(500) | 规格书URL | |
| manual_url | varchar(500) | 手册URL | |
| createdAt | timestamp | 创建时间 | 默认: now() |
| updatedAt | timestamp | 更新时间 | 默认: now() |

---

#### pump_performance_points (性能曲线点表)

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | uuid | ID | 主键 |
| pumpId | uuid | 水泵ID | 外键, 非空 |
| flowRate | decimal(10,2) | 流量 | 非空 |
| head | decimal(10,2) | 扬程 | 非空 |
| power | decimal(10,2) | 功率 | |
| efficiency | decimal(5,2) | 效率 | |
| createdAt | timestamp | 创建时间 | 默认: now() |

---

## 8. 部署指南

### 8.1 环境要求

- Node.js: v20.20.0+
- PostgreSQL: 14+
- pnpm: 9.0.0+

### 8.2 环境变量配置

创建 `.env` 文件：

```env
# 数据库配置
DATABASE_URL=postgresql://username:password@host:port/database
POSTGRES_URL=postgresql://username:password@host:port/database
PGDATABASE_URL=postgresql://username:password@host:port/database

# 数据库连接池配置
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10

# 应用配置
NODE_ENV=production
NEXT_PUBLIC_APP_NAME=洛瓦托水泵选型系统
NEXT_PUBLIC_APP_URL=https://your-domain.com

# API 配置
API_TIMEOUT=30000
```

### 8.3 安装依赖

```bash
pnpm install
```

### 8.4 数据库迁移

```bash
# 生成迁移文件
pnpm drizzle-kit generate

# 应用迁移
pnpm drizzle-kit push
```

### 8.5 启动服务

```bash
# 开发环境
pnpm run dev

# 生产环境
pnpm run build
pnpm run start
```

### 8.6 Nginx 配置示例

```nginx
server {
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
}
```

---

## 附录

### A. 匹配算法详细说明

本系统采用参考格兰富选型算法的智能匹配策略：

1. **连续运行范围**: 确保工作点在水泵的推荐运行范围内
2. **性能曲线匹配**: 使用二次曲线模型计算扬程
3. **最佳效率区间 (BEP)**: 优先选择在最大流量60%-120%范围内运行的水泵
4. **合理余量控制**: 扬程余量控制在5%-20%之间
5. **多维度评分**: 综合考虑流量、扬程、效率、应用场景等因素

### B. 性能曲线生成

系统使用二次曲线模型生成性能曲线：

```
H = H_shutOff - k * Q^2

其中:
- H: 扬程
- H_shutOff: 关断点扬程 (流量为0时的扬程)
- k: 曲线系数
- Q: 流量
```

### C. 技术支持

如有问题，请联系技术支持团队。

---

**文档版本**: v1.0.0  
**最后更新**: 2026-02-13
